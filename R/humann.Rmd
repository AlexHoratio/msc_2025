---
title: "HUMAnN"
output: html_document
date: "2025-06-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r imports, results = 'hide'}

library(tidyverse)
library(vegan)
source("humann_utils.r")

```

```{r get_pathabundance_files, results = 'hide'}

humann_prodigal <- data.frame()

for (filename in list.files("data/humann_wnanolyse/prodigal/")) {
  if (grepl("pathabundance", filename)) {
    if (length(humann_prodigal) == 0) {
      humann_prodigal <- read_tsv(paste0("data/humann_wnanolyse/prodigal/", filename), col_names = TRUE)
      colnames(humann_prodigal) <- c("Pathway", "Relative Abundance")
      humann_prodigal <- add_column(humann_prodigal, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      pathabundance <- read_tsv(paste0("data/humann_wnanolyse/prodigal/", filename), col_names = TRUE)
      colnames(pathabundance) <- c("Pathway", "Relative Abundance")
      pathabundance <- add_column(pathabundance, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_prodigal <- rbind(humann_prodigal, pathabundance)
    }
  }
}

humann_100bp_shreds <- data.frame()

for (filename in list.files("data/humann_wnanolyse/shredded_100bp/")) {
  if (grepl("pathabundance", filename)) {
    if (length(humann_100bp_shreds) == 0) {
      humann_100bp_shreds <- read_tsv(paste0("data/humann_wnanolyse/shredded_100bp/", filename), col_names = TRUE)
      colnames(humann_100bp_shreds) <- c("Pathway", "Relative Abundance")
      humann_100bp_shreds <- add_column(humann_100bp_shreds, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      pathabundance <- read_tsv(paste0("data/humann_wnanolyse/shredded_100bp/", filename), col_names = TRUE)
      colnames(pathabundance) <- c("Pathway", "Relative Abundance")
      pathabundance <- add_column(pathabundance, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_100bp_shreds <- rbind(humann_100bp_shreds, pathabundance)
    }
  }
}

humann_500bp_shreds <- data.frame()

for (filename in list.files("data/humann_wnanolyse/shredded_500bp/")) {
  if (grepl("pathabundance", filename)) {
    if (length(humann_500bp_shreds) == 0) {
      humann_500bp_shreds <- read_tsv(paste0("data/humann_wnanolyse/shredded_500bp/", filename), col_names = TRUE)
      colnames(humann_500bp_shreds) <- c("Pathway", "Relative Abundance")
      humann_500bp_shreds <- add_column(humann_500bp_shreds, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      pathabundance <- read_tsv(paste0("data/humann_wnanolyse/shredded_500bp/", filename), col_names = TRUE)
      colnames(pathabundance) <- c("Pathway", "Relative Abundance")
      pathabundance <- add_column(pathabundance, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_500bp_shreds <- rbind(humann_500bp_shreds, pathabundance)
    }
  }
}

humann_1kbp_shreds <- data.frame()

for (filename in list.files("data/humann/renormalized/shredded_1kbp")) {
  if (grepl("pathabundance", filename)) {
    if (length(humann_1kbp_shreds) == 0) {
      humann_1kbp_shreds <- read_tsv(paste0("data/humann/renormalized/shredded_1kbp/", filename), col_names = TRUE)
      colnames(humann_1kbp_shreds) <- c("Pathway", "Relative Abundance")
      humann_1kbp_shreds <- add_column(humann_1kbp_shreds, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      pathabundance <- read_tsv(paste0("data/humann/renormalized/shredded_1kbp/", filename), col_names = TRUE)
      colnames(pathabundance) <- c("Pathway", "Relative Abundance")
      pathabundance <- add_column(pathabundance, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_1kbp_shreds <- rbind(humann_1kbp_shreds, pathabundance)
    }
  }
}

humann_prodigal_community <- humann_prodigal[!grepl("|", humann_prodigal$Pathway, fixed = TRUE), ]
humann_100bp_shreds_community <- humann_100bp_shreds[!grepl("|", humann_100bp_shreds$Pathway, fixed = TRUE), ]
humann_500bp_shreds_community <- humann_500bp_shreds[!grepl("|", humann_500bp_shreds$Pathway, fixed = TRUE), ]
humann_1kbp_shreds_community <- humann_1kbp_shreds[!grepl("|", humann_1kbp_shreds$Pathway, fixed = TRUE), ]

```

```{r get_metacyc_metadata}

metacyc_metadata <- read_tsv("MetaCyc_pathway_metadata.txt", col_names = TRUE)
names(metacyc_metadata)[names(metacyc_metadata) == "Pathways"] <- "Pathway"

humann_prodigal_community_with_metadata <- humann_prodigal_community %>%
  add_column(PathwayDescription = str_trim(sapply(strsplit(humann_prodigal_community$Pathway, ":", fixed=TRUE), '[', 2))) %>%
  mutate(Pathway = sapply(strsplit(humann_prodigal_community$Pathway, ":", fixed=TRUE), '[', 1)) %>% 
  left_join(metacyc_metadata, by = "Pathway") 

humann_100bp_shreds_community_with_metadata <- humann_100bp_shreds_community %>%
  add_column(PathwayDescription = str_trim(sapply(strsplit(humann_100bp_shreds_community$Pathway, ":", fixed=TRUE), '[', 2))) %>%
  mutate(Pathway = sapply(strsplit(humann_100bp_shreds_community$Pathway, ":", fixed=TRUE), '[', 1)) %>% 
  left_join(metacyc_metadata, by = "Pathway") 

humann_500bp_shreds_community_with_metadata <- humann_500bp_shreds_community %>%
  add_column(PathwayDescription = str_trim(sapply(strsplit(humann_500bp_shreds_community$Pathway, ":", fixed=TRUE), '[', 2))) %>%
  mutate(Pathway = sapply(strsplit(humann_500bp_shreds_community$Pathway, ":", fixed=TRUE), '[', 1)) %>% 
  left_join(metacyc_metadata, by = "Pathway") 

humann_1kbp_shreds_community_with_metadata <- humann_1kbp_shreds_community %>%
  add_column(PathwayDescription = str_trim(sapply(strsplit(humann_1kbp_shreds_community$Pathway, ":", fixed=TRUE), '[', 2))) %>%
  mutate(Pathway = sapply(strsplit(humann_1kbp_shreds_community$Pathway, ":", fixed=TRUE), '[', 1)) %>% 
  left_join(metacyc_metadata, by = "Pathway") 

```

```{r get_genefamilies_files, results = 'hide'}

humann_prodigal_genefamilies <- data.frame()

for (filename in list.files("data/humann/renormalized/prodigal/")) {
  if (grepl("genefamilies", filename)) {
    if (length(humann_prodigal_genefamilies) == 0) {
      humann_prodigal_genefamilies <- read_tsv(paste0("data/humann/renormalized/prodigal/", filename), col_names = TRUE)
      colnames(humann_prodigal_genefamilies) <-  c("Gene Family", "RPKs")
      humann_prodigal_genefamilies <- add_column(humann_prodigal_genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      genefamilies <- read_tsv(paste0("data/humann/renormalized/prodigal/", filename), col_names = TRUE)
      colnames(genefamilies) <- c("Gene Family", "RPKs")
      genefamilies <- add_column(genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_prodigal_genefamilies <- rbind(humann_prodigal_genefamilies, genefamilies)
    }
  }
}

humann_100bp_shreds_genefamilies <- data.frame()

for (filename in list.files("data/humann_wnanolyse/shredded_100bp/")) {
  if (grepl("genefamilies", filename)) {
    if (length(humann_100bp_shreds_genefamilies) == 0) {
      humann_100bp_shreds_genefamilies <- read_tsv(paste0("data/humann_wnanolyse/shredded_100bp/", filename), col_names = TRUE)
      colnames(humann_100bp_shreds_genefamilies) <-  c("Gene Family", "RPKs")
      humann_100bp_shreds_genefamilies <- add_column(humann_100bp_shreds_genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      genefamilies <- read_tsv(paste0("data/humann_wnanolyse/shredded_100bp/", filename), col_names = TRUE)
      colnames(genefamilies) <- c("Gene Family", "RPKs")
      genefamilies <- add_column(genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_100bp_shreds_genefamilies <- rbind(humann_100bp_shreds_genefamilies, genefamilies)
    }
  }
}

humann_500bp_shreds_genefamilies <- data.frame()

for (filename in list.files("data/humann_wnanolyse/shredded_500bp/")) {
  if (grepl("genefamilies", filename)) {
    if (length(humann_500bp_shreds_genefamilies) == 0) {
      humann_500bp_shreds_genefamilies <- read_tsv(paste0("data/humann_wnanolyse/shredded_500bp/", filename), col_names = TRUE)
      colnames(humann_500bp_shreds_genefamilies) <-  c("Gene Family", "RPKs")
      humann_500bp_shreds_genefamilies <- add_column(humann_500bp_shreds_genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      genefamilies <- read_tsv(paste0("data/humann_wnanolyse/shredded_500bp/", filename), col_names = TRUE)
      colnames(genefamilies) <- c("Gene Family", "RPKs")
      genefamilies <- add_column(genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_500bp_shreds_genefamilies <- rbind(humann_500bp_shreds_genefamilies, genefamilies)
    }
  }
}


humann_1kbp_shreds_genefamilies <- data.frame()

for (filename in list.files("data/humann/renormalized/shredded_1kbp")) {
  if (grepl("genefamilies", filename)) {
    if (length(humann_1kbp_shreds_genefamilies) == 0) {
      humann_1kbp_shreds_genefamilies <- read_tsv(paste0("data/humann/renormalized/shredded_1kbp/", filename), col_names = TRUE)
      colnames(humann_1kbp_shreds_genefamilies) <-  c("Gene Family", "RPKs")
      humann_1kbp_shreds_genefamilies <- add_column(humann_1kbp_shreds_genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
    } else {
      genefamilies <- read_tsv(paste0("data/humann/renormalized/shredded_1kbp/", filename), col_names = TRUE)
      colnames(genefamilies) <- c("Gene Family", "RPKs")
      genefamilies <- add_column(genefamilies, SampleName = str_extract(filename, "[R]+[0-9]+"))
      
      humann_1kbp_shreds_genefamilies <- rbind(humann_1kbp_shreds_genefamilies, genefamilies)
    }
  }
}

humann_prodigal_genefamilies_notaxa <- humann_prodigal_genefamilies[!grepl("|", humann_prodigal_genefamilies$`Gene Family`, fixed = TRUE), ]
humann_100bp_shreds_genefamilies_notaxa <- humann_100bp_shreds_genefamilies[!grepl("|", humann_100bp_shreds_genefamilies$`Gene Family`, fixed = TRUE), ]
humann_500bp_shreds_genefamilies_notaxa <- humann_500bp_shreds_genefamilies[!grepl("|", humann_500bp_shreds_genefamilies$`Gene Family`, fixed = TRUE), ]
humann_1kbp_shreds_genefamilies_notaxa <- humann_1kbp_shreds_genefamilies[!grepl("|", humann_1kbp_shreds_genefamilies$`Gene Family`, fixed = TRUE), ]

```


```{r heatmap_of_community_pathways}

humann_prodigal_community_pathways_with_metadata <- humann_prodigal_community_with_metadata[str_trim(humann_prodigal_community_with_metadata$Pathway) != "UNMAPPED" & str_trim(humann_prodigal_community_with_metadata$Pathway) != "UNINTEGRATED", ]

humann_prodigal_community_pathways_with_metadata <- humann_prodigal_community_pathways_with_metadata[order(humann_prodigal_community_pathways_with_metadata$`Ontology - pathway type`, humann_prodigal_community_pathways_with_metadata$`Ontology - direct parents of entity`, humann_prodigal_community_pathways_with_metadata$`PathwayDescription`), ]

#community_pathway_heatmap <- ggplot(humann_prodigal_community_pathways_with_metadata, aes(x = SampleName, y = factor(PathwayDescription, levels = unique(humann_prodigal_community_pathways_with_metadata$`PathwayDescription`)), fill = log(`Relative Abundance`))) + 
#  geom_tile(colour = "#00000000", show.legend = FALSE) + 
#  theme(
#    panel.background = element_rect(fill = '#fff'),
#    panel.grid.major.y = element_line(colour="#00000000"),
#    panel.grid.major.x = element_line(colour="#00000011"),
#    plot.background = element_rect(fill = '#fff'),
#    legend.background = element_rect(fill = '#fff')
#  )

community_pathway_heatmap <- ggplot(humann_prodigal_community_pathways_with_metadata, aes(x = SampleName, y = factor(`Ontology - pathway type`), fill = log(`Relative Abundance`))) + 
  geom_tile(colour = "#00000000", show.legend = FALSE) + 
  theme(
    panel.background = element_rect(fill = '#fff'),
    panel.grid.major.y = element_line(colour="#00000000"),
    panel.grid.major.x = element_line(colour="#00000011"),
    plot.background = element_rect(fill = '#fff'),
    legend.background = element_rect(fill = '#fff')
  )

ggsave("graphs/humann/community_pathway_heatmap_prodigal.png", community_pathway_heatmap, units = "px", height = 4000, width = 2700, limitsize = FALSE)
community_pathway_heatmap

humann_1kbp_shreds_community_pathways_with_metadata <- humann_1kbp_shreds_community_with_metadata[str_trim(humann_1kbp_shreds_community_with_metadata$Pathway) != "UNMAPPED" & str_trim(humann_1kbp_shreds_community_with_metadata$Pathway) != "UNINTEGRATED", ]

humann_1kbp_shreds_community_pathways_with_metadata <- humann_1kbp_shreds_community_pathways_with_metadata[order(humann_1kbp_shreds_community_pathways_with_metadata$`Ontology - pathway type`, humann_1kbp_shreds_community_pathways_with_metadata$`Ontology - direct parents of entity`, humann_1kbp_shreds_community_pathways_with_metadata$`PathwayDescription`), ]

community_pathway_heatmap <- ggplot(humann_1kbp_shreds_community_pathways_with_metadata, aes(x = SampleName, y = factor(PathwayDescription, levels = unique(humann_1kbp_shreds_community_pathways_with_metadata$`PathwayDescription`)), fill = log(`Relative Abundance`))) + 
  geom_tile(colour = "#00000000", show.legend = FALSE) + 
  theme(
    panel.background = element_rect(fill = '#fff'),
    panel.grid.major.y = element_line(colour="#00000000"),
    panel.grid.major.x = element_line(colour="#00000011"),
    plot.background = element_rect(fill = '#fff'),
    legend.background = element_rect(fill = '#fff')
  )

ggsave("graphs/humann/community_pathway_heatmap_1kbp_shreds.png", community_pathway_heatmap, units = "px", height = 17000, width = 2700, limitsize = FALSE)
community_pathway_heatmap

humann_100bp_shreds_community_pathways_with_metadata <- humann_100bp_shreds_community_with_metadata[str_trim(humann_100bp_shreds_community_with_metadata$Pathway) != "UNMAPPED" & str_trim(humann_100bp_shreds_community_with_metadata$Pathway) != "UNINTEGRATED", ]

humann_100bp_shreds_community_pathways_with_metadata <- humann_100bp_shreds_community_pathways_with_metadata[order(humann_100bp_shreds_community_pathways_with_metadata$`Ontology - pathway type`, humann_100bp_shreds_community_pathways_with_metadata$`Ontology - direct parents of entity`, humann_100bp_shreds_community_pathways_with_metadata$`PathwayDescription`), ]

community_pathway_heatmap <- ggplot(humann_100bp_shreds_community_pathways_with_metadata, aes(x = SampleName, y = factor(PathwayDescription, levels = unique(humann_100bp_shreds_community_pathways_with_metadata$`PathwayDescription`)), fill = log(`Relative Abundance`))) + 
  geom_tile(colour = "#00000000", show.legend = FALSE) + 
  theme(
    panel.background = element_rect(fill = '#fff'),
    panel.grid.major.y = element_line(colour="#00000000"),
    panel.grid.major.x = element_line(colour="#00000011"),
    plot.background = element_rect(fill = '#fff'),
    legend.background = element_rect(fill = '#fff')
  )

ggsave("graphs/humann/community_pathway_heatmap_100bp_shreds.png", community_pathway_heatmap, units = "px", height = 17000, width = 2700, limitsize = FALSE)
community_pathway_heatmap

#for (pathway in humann_prodigal_community_pathways_with_metadata$PathwayDescription) {
#  graph <- ggplot(na.omit(humann_prodigal_community_pathways_with_metadata[humann_prodigal_community_pathways_with_metadata$`PathwayDescription` == pathway & !is.na(humann_prodigal_community_pathways_with_metadata$PathwayDescription), ]), aes(x = SampleName, y = log(`Relative Abundance`))) + 
#    geom_bar(stat = "identity", show.legend = FALSE) + 
#    ggtitle(pathway)
  
#  ggsave(paste0("graphs/humann/breakdown/", str_replace_all(string = pathway, pattern = "/", replacement = ""), ".png"), graph, units = "px", height = 2000, width = 2750)
#}

```

```{r barchart_of_unmapped}

unmapped_unintegrated_humann <- rbind(
  humann_prodigal_community[humann_prodigal_community$Pathway == "UNMAPPED" | humann_prodigal_community$Pathway == "UNINTEGRATED", ] %>% add_column(Input = "Prodigal ORFs"),
  humann_1kbp_shreds_community[humann_1kbp_shreds_community$Pathway == "UNMAPPED" | humann_1kbp_shreds_community$Pathway == "UNINTEGRATED", ] %>% add_column(Input = "1kbp Shreds"),
  humann_100bp_shreds_community[humann_100bp_shreds_community$Pathway == "UNMAPPED" | humann_100bp_shreds_community$Pathway == "UNINTEGRATED", ] %>% add_column(Input = "100bp Shreds"),
  humann_500bp_shreds_community[humann_500bp_shreds_community$Pathway == "UNMAPPED" | humann_500bp_shreds_community$Pathway == "UNINTEGRATED", ] %>% add_column(Input = "500bp Shreds")
)

unmapped_reads <- ggplot(unmapped_unintegrated_humann[unmapped_unintegrated_humann$Pathway == "UNMAPPED", ], aes(x = SampleName, y = `Relative Abundance`, fill = Input)) + 
  geom_bar(stat = "identity", position = position_dodge()) + 
  ggtitle("Abundance of Unmapped Reads (reads that do not map to any genes)")

ggsave("graphs/humann/unmapped_reads.png", unmapped_reads, units = "px", width = 3000, height = 2500)
unmapped_reads

unintegrated_genes <- ggplot(unmapped_unintegrated_humann[unmapped_unintegrated_humann$Pathway == "UNINTEGRATED", ], aes(x = SampleName, y = `Relative Abundance`, fill = Input)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  ggtitle("Abundance of Unintegrated Genes (genes that do not belong to a MetaCyc pathway definition)") 

ggsave("graphs/humann/unintegrated_genes.png", unintegrated_genes, units = "px", width = 3000, height = 2500)
unintegrated_genes

```


```{r ordination}

humann_prodigal_community_for_ordination <- humann_prodigal_community %>%
  pivot_wider(
    names_from = SampleName,
    values_from = `Relative Abundance`,
    values_fill = 0,
    values_fn = sum
  )

humann_prodigal_mds <- metaMDS(as.data.frame(t(humann_prodigal_community_for_ordination[, -c(1)])))

humann_100bp_shreds_community_for_ordination <- humann_100bp_shreds_community %>%
  pivot_wider(
    names_from = SampleName,
    values_from = `Relative Abundance`,
    values_fill = 0,
    values_fn = sum
  )

humann_100bp_shreds_mds <- metaMDS(as.data.frame(t(humann_100bp_shreds_community_for_ordination[, -c(1)])))

humann_500bp_shreds_community_for_ordination <- humann_500bp_shreds_community %>%
  pivot_wider(
    names_from = SampleName,
    values_from = `Relative Abundance`,
    values_fill = 0,
    values_fn = sum
  )

humann_500bp_shreds_mds <- metaMDS(as.data.frame(t(humann_500bp_shreds_community_for_ordination[, -c(1)])))

humann_1kbp_shreds_community_for_ordination <- humann_1kbp_shreds_community %>%
  pivot_wider(
    names_from = SampleName,
    values_from = `Relative Abundance`,
    values_fill = 0,
    values_fn = sum
  )

humann_1kbp_shreds_mds <- metaMDS(as.data.frame(t(humann_1kbp_shreds_community_for_ordination[, -c(1)])))


ggplot(as.data.frame(humann_prodigal_mds[["points"]]), aes(x = MDS1, y = MDS2, label = rownames(as.data.frame(humann_prodigal_mds[["points"]])))) +
  geom_point() + 
  geom_text()

ggplot(as.data.frame(humann_100bp_shreds_mds[["points"]]), aes(x = MDS1, y = MDS2, label = rownames(as.data.frame(humann_100bp_shreds_mds[["points"]])))) +
  geom_point() + 
  geom_text()

ggplot(as.data.frame(humann_500bp_shreds_mds[["points"]]), aes(x = MDS1, y = MDS2, label = rownames(as.data.frame(humann_500bp_shreds_mds[["points"]])))) +
  geom_point() + 
  geom_text()

ggplot(as.data.frame(humann_1kbp_shreds_mds[["points"]]), aes(x = MDS1, y = MDS2, label = rownames(as.data.frame(humann_1kbp_shreds_mds[["points"]])))) +
  geom_point() + 
  geom_text()

```