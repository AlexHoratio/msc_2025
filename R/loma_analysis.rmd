---
title: "LOMA Analysis"
author: "Alex Caswell"
date: "2025-04-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r imports}

source("get_stats_from_readqc.r")
library(ggtext)
library(sitools)
library(cowplot)
library(ggExtra)

```

# What's the plan?!

We need...

-   Read statistics for every input file (*b.p., n50, \# reads, filesize*)
-   Assembly information
    -   \# of contigs
    -   \# of bins
-   *Diversity information*
    -   Shannon/Inv. Simpson

```{r read_statistics}

read_statistics <- get_tsv_from_run_folder("RUN01/RUN01/")


```

```{r histogram_of_n50}

histogram_of_n50 <- ggplot(read_statistics, aes(x=read_n50)) +
  geom_histogram(binwidth=1000, boundary = 0, closed = "left", col="grey") + 
  theme_classic() +
  scale_fill_brewer(palette = "Set1") + 
  ylab("Count") + 
  xlab("N50") + 
  scale_x_continuous(breaks = seq(0, 30000, 2000)) +
  theme(
    axis.title.x = element_markdown(size = 20),
    axis.title.y = element_markdown(size = 20),
  )

ggsave("graphs/loma/example/histogram_n50.png", histogram_of_n50, width = 2100, height = 1600, units="px")
histogram_of_n50

```

```{r histogram_of_number_of_reads}

histogram_of_number_of_reads <- ggplot(read_statistics, aes(x=number_of_reads)) +
  geom_histogram(binwidth=1000000, boundary = 0, closed = "left", col="grey") + 
  theme_classic() +
  scale_fill_brewer(palette = "Set1") + 
  ylab("") + 
  xlab("Number of Reads") + 
  scale_x_continuous(breaks = seq(0, 18000000, 2000000), labels=f2si) +
  theme(
    axis.title.x = element_markdown(size = 20),
    axis.title.y = element_markdown(size = 20),
  )

ggsave("graphs/loma/example/histogram_of_number_of_reads.png", histogram_of_number_of_reads, width = 2100, height = 1600, units="px")
histogram_of_number_of_reads

```


```{r histogram_of_total_bases}

histogram_of_total_bases <- ggplot(read_statistics, aes(x=total_bases_mbp)) +
  geom_histogram(binwidth=2000, boundary = 0, closed = "left", col="grey") + 
  theme_classic() +
  scale_fill_brewer(palette = "Set1") + 
  ylab("Count") + 
  xlab("Total Bases (Mbp)") + 
  scale_x_continuous(breaks = seq(0, 60000, 10000), labels=f2si) +
  theme(
    axis.title.x = element_markdown(size = 20),
    axis.title.y = element_markdown(size = 20),
  )

ggsave("graphs/loma/example/histogram_of_total_bases.png", histogram_of_total_bases, width = 2100, height = 1600, units="px")
histogram_of_total_bases

```

```{r make_sequencing_stats_panel}

sequencing_stats_panel <- plot_grid(plot_grid(histogram_of_total_bases, histogram_of_number_of_reads, labels=c("A", "B")), histogram_of_n50, ncol=1, labels=c("", "C"))
ggsave("graphs/loma/example/sequencing_stats_panel.png", sequencing_stats_panel, height=2100, width=3200, units="px")

```

```{r integrated_sequencing_stats}

integrated_scatter <- ggplot(read_statistics, aes(x=read_n50, y=number_of_reads, size = total_bases_mbp)) +
  geom_point() + 
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 30000, 2000), labels=f2si) +
  scale_y_continuous(breaks = seq(0, 18000000, 2000000), labels=f2si) +
  scale_size_continuous(name="Total Bases (Mbp)") +
  xlab("N50") +
  ylab("Number of Reads") +
  theme(
    legend.position = "left"
  )

marginal_integrated_scatter <- ggMarginal(integrated_scatter, type="histogram")
ggsave("graphs/loma/example/marginal_integrated_scatter.png", marginal_integrated_scatter)
marginal_integrated_scatter
```

```{r make_graphs}


filtered_read_statistics <- read_statistics[read_statistics$bin_count != 0,]

make_ggplot_scatterplot(read_statistics, read_statistics$total_bases_mbp, read_statistics$bin_count) + 
  geom_point(aes(color = read_statistics$bin_count == 0)) + 
  xlab("Total Bases (mbp)") + 
  ylab("Number of bins")

make_ggplot_scatterplot(filtered_read_statistics, filtered_read_statistics$read_n50, filtered_read_statistics$average_bin_n50) + 
  geom_point(aes(color = "red")) + 
  #geom_smooth(method = "lm", alpha = 0.1) +
  xlab("Input Read N50") + 
  ylab("Average Bin N50")


```

```{r compare_bin_count_to_x}


ggplot(read_statistics, aes(x = total_bases_mbp, y = bin_count)) + 
  geom_point()

ggplot(read_statistics, aes(x = number_of_reads, y = bin_count)) + 
  geom_point()

ggplot(read_statistics, aes(x = read_n50, y = bin_count)) + 
  geom_point()

ggplot(read_statistics, aes(x = mean_read_length, y = bin_count)) + 
  geom_point()

```


```{r number_of_bins}


number_of_bins <- ggplot(read_statistics, aes(x = run_accession, y = bin_count, fill = run_accession)) + 
  geom_bar(stat="identity") +
  geom_text(label = read_statistics$bin_count, size = 10, vjust = -0.2) +
  scale_fill_brewer(palette = "Set1") +
  scale_x_discrete(labels = c("R003", "R004", "R005", "R007")) +
  ylab("\\# of MAGs") +
  xlab("") +
  expand_limits(y = c(0, 300)) +
  theme_classic() +
  theme(
    axis.text.y = element_markdown(size = 16),
    axis.text.x = element_markdown(size = 20),
    axis.title.x = element_markdown(size = 20),
    axis.title.y = element_markdown(size = 20),
    panel.spacing = unit(1, "lines"),
    strip.text = element_markdown(face = "bold", size = 12),
    panel.background = element_rect(fill = '#fff7ef'),
    plot.background = element_rect(fill = '#fff7ef'),
    legend.background = element_rect(fill = '#fff7ef'),
    legend.text = element_markdown(size = 12),
    legend.title = element_blank()
  )

number_of_bins
ggsave("graphs/loma/number_of_bins.png", number_of_bins)

```
